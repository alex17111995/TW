<!DOCTYPE HTML>
<html>

<head>
    <link rel="stylesheet" href="./material.min.css">
    <link rel="stylesheet" href="./layout.css">
    <link rel="stylesheet" href="./components.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxetv4Nz-l2t47HuUuMocoVhC5yy07MDI&libraries=drawing"></script>
    <script type="text/javascript">
        var kidMap, targetDrawer, staticTargetKidID;
        var nearbyKids = [{
            "username": "Adrian Butnaru"
            , "first_name": "Adrian"
            , "last_name": "Butnaru"
        }, {
            "username": "Alexandru Ciubotariu"
            , "first_name": "Alexandru"
            , "last_name": "Ciubotariu"
        }]
        var staticTargetCount = new Map();
        var alertCount = 0;
        var dataStructure = {
            "credentials": {
                "pid": 2
                , "username": "Alexandru Sebastian"
                , "first_name": "Alexandru"
                , "last_name": "Sebastian"
            }
            , "children": [
                {
                    kid_location_and_name: {
                        first_name: "Ciuc"
                        , last_name: "Tiberiu"
                        , latitude: 47.2134086
                        , longitude: 27.506618208900048
                        , username: "ctiby777"
                        , kid: 3
                        , is_online: false
                        , last_update_timestamp: 8457
                    }
                    , "dynamic_targets": [
                        {
                            "radius": 100
                            , "latitude": 47.154854968767
                            , "longitude": 27.60144179576599975
                            , "pid": 5
                            , "last_timestamp_update": 8234
                            , is_online: true
        }
      ]
                    , "static_targets": [
                        {
                            "radius": 100
                            , "static_target_id": 1
                            , "latitude": 47.1854546
                            , "longitude": 27.60144179576587975
        }, {
                            "radius": 80
                            , "static_target_id": 2
                            , "latitude": 47.1584546565865685
                            , "longitude": 27.60144179576587456
        }
      ]
                    , "child_handlers": [
                        {
                            "pid": 5
                            , "first_name": "Ben"
                            , "last_name": "Dover"
                            , "username": "Vasilescu"
                            , "is_dynamic_target": true

        }
      ]
    }
  ]
        }


        function loadMap() {

            kidMap = new google.maps.Map(document.getElementById("map"), {
                center: new google.maps.LatLng(47.165528, 27.560970)
                , zoom: 16
                , mapTypeId: google.maps.MapTypeId.ROADMAP
                , disableDefaultUI: true
                , scaleControl: true
                , scaleControlOptions: {
                    position: google.maps.ControlPosition.BOTTOM_LEFT
                }
            });

            targetDrawer = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.CIRCLE
                , drawingControl: false
                , drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER
                    , drawingModes: [google.maps.drawing.OverlayType.MARKER, google.maps.drawing.OverlayType.CIRCLE]
                }
                , circleOptions: {
                    strokeColor: '#333F4F'
                    , strokeOpacity: 1
                    , strokeWeight: 1
                    , fillColor: getRandomColor()
                    , fillOpacity: 0.4
                    , map: kidMap
                    , editable: false
                    , draggable: false
                }
            });

            targetDrawer.setMap(null);
            google.maps.event.addListener(targetDrawer, 'circlecomplete', function (circle) {
                sendTargetToServer(circle);
                circle.setMap(null);
            });
        }
        google.maps.event.addDomListener(window, 'load', loadMap);

        function enableStaticTargetDrawing(kid) {
            targetDrawer.setMap(kidMap);
            staticTargetKidID = kid;
        }

        function sendTargetToServer(circle) {
            var newStaticTarget = {
                "kid": staticTargetKidID
                , "radius": circle.getRadius()
                , "latitude": circle.getCenter().lat()
                , "longitude": circle.getCenter().lng()
            }

            targetDrawer.setMap(null);
            sendToServer(newStaticTarget);

        }


        function moveKid(kidUpdatedInfo) {
            var i = 0;
            for (i = 0; i < dataStructure.children.length; i++) {
                if (dataStructure.children[i].kid_location_and_name.kid == kidUpdatedInfo.kid) {
                    dataStructure.children[i].kid_location_and_name.latitude = kidUpdatedInfo.latitude;
                    dataStructure.children[i].kid_location_and_name.longitude = kidUpdatedInfo.longitude;
                    dataStructure.children[i].kid_location_and_name.last_update_timestamp = kidUpdatedInfo.timestamp;
                    dataStructure.children[i].kid_location_and_name.marker.setPosition(new google.maps.LatLng(kidUpdatedInfo.latitude, kidUpdatedInfo.longitude));
                }
            }
        }

        function getHandlerNameByPID(kid, pid) {
            var i, j, handlerName = "error loading name";

            for (i = 0; i < dataStructure.children.length; i++) {
                if (dataStructure.children[i].kid_location_and_name.kid == kid) {
                    for (j = 0; j < dataStructure.children[i].child_handlers.length; j++) {
                        if (dataStructure.children[i].child_handlers[j].pid == pid) {
                            handlerName = dataStructure.children[i].child_handlers[j].first_name + " " + dataStructure.children[i].child_handlers[j].last_name;
                        }
                    }
                }
            }
            return handlerName;
        }



        var shitTarget = {
            latitude: 45
            , longitude: 27
            , radius: 2000
            , static_target_id: 34
            , kid: 3
        }

        function getRandomColor() {
            var colorPallete = ["#E57373", "#304FFE", "#D50000", "#8C9EFF", "#66BB6A", "#EEFF41", "#FF6E40", "#00BFA5", "#607D8B", "#18FFFF", "#82B1FF", "#E91E63", "#F44336", "#8BC34A", "#FFEB3B", "#6D4C41"];
            color = colorPallete[Math.floor(Math.random() * 16)]
            return color;
        }

        function dismissAlert(alertID) {
            document.getElementById("alert" + alertID).parentNode.parentNode.removeChild(document.getElementById("alert" + alertID).parentNode);
            addNewStaticTarget(shitTarget);
        }

        var testAlert = {
            kid: 3
            , type: 2
        };



        var testKidInformation = {
            first_name: "Ciuc"
            , last_name: "Tiberiu"
            , latitude: 47.2134086
            , longitude: 27.506618208900048
            , username: "ctiby777"
            , kid: 3
            , is_online: true
            , last_update_timestamp: 8457
        }

        function showNewKidHelp() {
            document.getElementById("newKidHelp").style.visibility = "visible";
        }

        function hideNewKidHelp() {
            document.getElementById("newKidHelp").style.visibility = "hidden";
        }

        function addDynamicTarget(childID) {
            var newDynamicTargetRadius = document.getElementById("proximitySlider" + childID).value;

            socket.emit("make_dynamic", {
                kid: Number.parseInt(childID)
                , radius: Number.parseInt(newDynamicTargetRadius)
            });
        }

        function isDynamicTarget(childID, parentID) {
            var i = 0
                , j = 0;

            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    for (j = 0; j < dataStructure.children[i].dynamic_targets.length; ++j) {
                        if (dataStructure.children[i].dynamic_targets[j].pid == parentID)
                            return true;
                    }
                }
            }
            return false;
        }

        function insertNewDynamicTarget(newTargetInformation) {
            var i = 0
                , j = 0
                , statusIcon = "offline_icon.png"
                , targetsCode = ""
                , newTarget;

            if (isDynamicTarget(newTargetInformation.kid, newTargetInformation.pid)) {
                for (i = 0; i < dataStructure.children.length; i++) {
                    if (dataStructure.children[i].kid_location_and_name.kid == newTargetInformation.kid) {
                        for (j = 0; j < dataStructure.children[i].dynamic_targets.length; ++j) {
                            if (dataStructure.children[i].dynamic_targets[j].pid == newTargetInformation.pid) {
                                dataStructure.children[i].dynamic_targets[j].radius = newTargetInformation.radius;
                                dataStructure.children[i].dynamic_targets[j].latitude = newTargetInformation.latitude;
                                dataStructure.children[i].dynamic_targets[j].longitude = newTargetInformation.longitude;
                                dataStructure.children[i].dynamic_targets[j].pid = newTargetInformation.pid;
                                dataStructure.children[i].dynamic_targets[j].last_timestamp_update = newTargetInformation.timestamp_last_update;
                                dataStructure.children[i].dynamic_targets[j].is_online = newTargetInformation.is_online;
                                dataStructure.children[i].dynamic_targets[j].circle.setRadius(newTargetInformation.radius);
                            }
                        }
                    }
                }
            } else {
                for (i = 0; i < dataStructure.children.length; ++i) {
                    if (dataStructure.children[i].kid_location_and_name.kid == newTargetInformation.kid) {
                        dataStructure.children[i].dynamic_targets.push({
                            radius: newTargetInformation.radius
                            , latitude: newTargetInformation.latitude
                            , longitude: newTargetInformation.longitude
                            , pid: newTargetInformation.pid
                            , last_timestamp_update: newTargetInformation.timestamp_last_update
                            , is_online: newTargetInformation.is_online
                            , circle: new google.maps.Circle({
                                strokeColor: '#333F4F'
                                , strokeOpacity: 1
                                , strokeWeight: 1
                                , fillColor: getRandomColor()
                                , fillOpacity: 0.4
                                , map: null
                                , editable: false
                                , draggable: false
                                , center: new google.maps.LatLng(newTargetInformation.latitude, newTargetInformation.longitude)
                                , radius: newTargetInformation.radius
                            })
                            , marker: new google.maps.Marker({
                                position: new google.maps.LatLng(newTargetInformation.latitude, newTargetInformation.longitude)
                                , map: null
                                , label: "P"
                            })
                        })
                    }
                }
                if (newTargetInformation.is_online)
                    statusIcon = "online_icon.png";

                if (newTargetInformation.pid == dataStructure.credentials.pid) {
                    targetsCode += "<div><button id=\"dynamicTarget" + newTargetInformation.pid + "." + newTargetInformation.kid + "\" class=\"dt-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect\" style = \"width:170px;\" onclick =\"centerOnDynamicTarget(" + newTargetInformation.kid + "," + newTargetInformation.pid + ")\">" + getHandlerNameByPID(newTargetInformation.kid, newTargetInformation.pid) + "<img id=\"statusIcon" + newTargetInformation.pid + "." + newTargetInformation.kid + "\" src=\"" + statusIcon + "\" alt=\"status\" height=\"15px\" width=\"15px\" style = \"position: absolute; right: 12px; top: 10px;\"></button>";
                    targetsCode += "<button class=\"mdl-button mdl-js-button mdl-button--icon\" onclick = \"sendDynamicTargetDeleteRequest(" + newTargetInformation.kid + "," + newTargetInformation.pid + ")\"><i class=\"material-icons\">delete</i></button></div>";
                } else {
                    targetsCode += "<div><button id=\"dynamicTarget" + newTargetInformation.pid + "." + newTargetInformation.kid + "\" class=\"dt-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect\" onclick =\"centerOnDynamicTarget(" + newTargetInformation.kid + "," + newTargetInformation.pid + ")\">" + getHandlerNameByPID(newTargetInformation.kid, newTargetInformation.pid) + "<img id=\"statusIcon" + newTargetInformation.pid + "." + newTargetInformation.kid + "\" src=\"" + statusIcon + "\" alt=\"status\" height=\"15px\" width=\"15px\" style = \"position: absolute; right: 12px; top: 10px;\"></button></div>";
                }
                newTarget = document.createElement("e");
                document.getElementById("dynamicTargets" + newTargetInformation.kid).appendChild(newTarget).innerHTML = targetsCode;
                componentHandler.upgradeDom();
            }
        }

        function closeProxMenu(childID) {
            document.getElementById("proxMenu" + childID).innerHTML = "";
        }

        function showProxMenu(childID) {
            document.getElementById("proxMenu" + childID).innerHTML = "";
            var proxMenuCode = "";
            proxMenuCode += "<br/>";
            proxMenuCode += "<input id=\"proximitySlider" + childID + "\" class=\"mdl-slider mdl-js-slider\" type=\"range\" min=\"10\" max=\"100\" value=\"25\">";
            proxMenuCode += "<div class=\"mdl-tooltip mdl-tooltip--large\" for=\"proximitySlider" + childID + "\">Drag to change radius.<br/>Values between 10 and 100 meters.</div><br/>";
            proxMenuCode += "<button class=\"mdl-button mdl-js-button mdl-button--primary\" onclick = \"addDynamicTarget('" + childID + "');closeProxMenu('" + childID + "');\" style =\"margin-bottom:5px;\">Done</button>";
            proxMenuCode += "<button class=\"mdl-button mdl-js-button mdl-button--accent\" style=\"position: relative; left: 45px;margin-bottom:5px;\" onclick = \"closeProxMenu('" + childID + "');\" >Cancel</button>"
            var newProxMenu = document.createElement("e");
            document.getElementById("proxMenu" + childID).appendChild(newProxMenu).innerHTML = proxMenuCode;
            componentHandler.upgradeDom();

        }

        function newKidAlert(kidInformation) {
            var alertCode = "";
            alertCode += "<div id =\"alert" + alertCount + "\" class=\"new-kid-notification-card mdl-card mdl-shadow--8dp\">";
            alertCode += "<div class=\"mdl-card__title mdl-card--border\">";
            alertCode += "<h2 class=\"mdl-card__title-text\">Child <br/> registered!</h2></div>";
            alertCode += "<div class=\"mdl-card__supporting-text\">" + kidInformation.kid_location_and_name.first_name + " " + kidInformation.kid_location_and_name.last_name + " has been registered! Click below to learn more!</div>";
            alertCode += "<div class=\"mdl-card__actions mdl-card--border\">";
            alertCode += "<button onclick = \" dismissAlert('" + (alertCount) + "');showNewKidHelp()\" class=\"mdl-button mdl-js-button mdl-button--raised mdl-button--primary\">Learn More</button>&#160;&#160;&#160;";
            alertCode += "<button onclick = \" dismissAlert('" + (alertCount++) + "')\" class=\"mdl-button mdl-js-button mdl-button--raised mdl-button--accent\">Dismiss</button></div></div>";

            var newNotification = document.createElement("e");
            document.getElementById('notification-holder').insertBefore(newNotification, document.getElementById('notification-holder').childNodes[0]).innerHTML = alertCode;
        }

        function areaUpdateAlert(alertInfo) {
            var alertCode = "";
            var message;
            if (alertInfo.alert_type == 1) message = " has entered a new marked area!";
            else message = " is now outside of his marked areas!";

            alertCode += "<div id=\"alert" + alertCount + "\" class=\"alert-notification-card mdl-card mdl-shadow--8dp\">";
            alertCode += "<div class=\"mdl-card__title mdl-card--border\">";
            alertCode += "<h2 class=\"mdl-card__title-text\">Alert!</h2></div>";
            alertCode += "<div class=\"mdl-card__supporting-text\">" + getNameFromKid(alertInfo.kid) + message + "</div>";
            alertCode += "<div class=\"mdl-card__actions mdl-card--border\">";
            alertCode += "<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent\" onclick = \"dismissAlert('" + (alertCount++) + "')\"> Dismiss </button></div></div>";
            var newNotification = document.createElement("e");
            document.getElementById('notification-holder').insertBefore(newNotification, document.getElementById('notification-holder').childNodes[0]).innerHTML = alertCode;

        }

        function getNameFromKid(targetKid) {
            var i = 0;
            for (i = 0; i < dataStructure.children.length; i++) {
                if (dataStructure.children[i].kid_location_and_name.kid == targetKid)
                    return dataStructure.children[i].kid_location_and_name.first_name + " " + dataStructure.children[i].kid_location_and_name.last_name;
            }
        }

        function testAreaUpdateAlert() {
            areaUpdateAlert(testAlert);
        }

        function sendStaticTargetDeleteRequest(targetID) {
            socket.emit('delete_static_target', Number.parseInt(targetID));
        }

        function getStaticTarget(targetID) {
            var i = 0
                , j = 0;

            for (i = 0; i < dataStructure.children.length; ++i) {
                for (j = 0; j < dataStructure.children[i].static_targets.length; ++j) {
                    if (dataStructure.children[i].static_targets[j].static_target_id == targetID)
                        return dataStructure.children[i].static_targets[j];
                }
            }
        }

        function toggleEdit(targetID) {
            var sTarget = getStaticTarget(targetID);
            if (sTarget.circle.editable == false)
                sTarget.circle.set('editable', true);
            else sTarget.circle.set('editable', false);
        }

        function centerOnStaticTarget(targetID) {
            var i = 0
                , j = 0;
            for (i = 0; i < dataStructure.children.length; ++i)
                for (j = 0; j < dataStructure.children[i].static_targets.length; ++j) {
                    if (dataStructure.children[i].static_targets[j].static_target_id == targetID) {
                        console.log(dataStructure)
                        console.log(dataStructure.children[i].static_targets[j].circle);
                        kidMap.panTo(dataStructure.children[i].static_targets[j].circle.getCenter());

                    }
                }
            kidMap.setZoom(18);
        }

        function centerOnChild(kidID) {
            var i = 0;
            for (i = 0; i < dataStructure.children.length; i++) {
                if (dataStructure.children[i].kid_location_and_name.kid == kidID) {
                    kidMap.panTo(new google.maps.LatLng(dataStructure.children[i].kid_location_and_name.latitude, dataStructure.children[i].kid_location_and_name.longitude));
                    kidMap.setZoom(18);
                }
            }
        }

        function centerOnDynamicTarget(childID, parentID) {
            var i = 0
                , j = 0;
            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    for (j = 0; j < dataStructure.children[i].dynamic_targets.length; ++j) {
                        if (dataStructure.children[i].dynamic_targets[j].pid == parentID)
                            kidMap.panTo(dataStructure.children[i].dynamic_targets[j].circle.getCenter());
                    }
                }
            }
            kidMap.setZoom(18);
        }

        function loadUsername() {
            var currentUser = document.createElement("e");
            document.getElementById('username').appendChild(currentUser).innerHTML = dataStructure.credentials.first_name + " " + dataStructure.credentials.last_name;
            componentHandler.upgradeDom();
        }

        function loadKids() {
            var i = 0;
            for (i = 0; i < dataStructure.children.length; i++) {
                var newKidCard = document.createElement("p");




                document.getElementById('cards').appendChild(newKidCard).innerHTML = generateChildCard(dataStructure.children[i]);
            }

            componentHandler.upgradeDom();
        }

        function showPasswordChangeMenu(childID) {
            var passChangeMenuCode = "";
            passChangeMenuCode += "<form action=\"\">"
            passChangeMenuCode += "<div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\">";
            passChangeMenuCode += "<input class=\"mdl-textfield__input\" type=\"password\" id=\"newPass" + childID + "\" required>";
            passChangeMenuCode += "<label class=\"mdl-textfield__label\" for=\"newPass" + childID + "\">New password</label></div>";
            passChangeMenuCode += "<div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\">";
            passChangeMenuCode += "<input class=\"mdl-textfield__input\" type=\"password\" id=\"newPassConfirm" + childID + "\" required>";
            passChangeMenuCode += "<label class=\"mdl-textfield__label\" for=\"newPassConfirm" + childID + "\">Confirm password</label></div>";
            passChangeMenuCode += "</form>";
            passChangeMenuCode += "<button class=\"mdl-button mdl-js-button mdl-button--primary\"  onclick= \"submitPasswordChange('" + childID + "')\" style =\"margin-bottom:5px;\">Submit</button>";
            passChangeMenuCode += "<button class=\"mdl-button mdl-js-button mdl-button--accent\" style=\"position: relative; left: 30px;margin-bottom:5px;\" onclick = \"closePassChangeMenu('" + childID + "')\">Cancel</button>"

            document.getElementById("passwordChangeMenu" + childID).innerHTML = passChangeMenuCode;
            componentHandler.upgradeDom();
        }

        function closePassChangeMenu(childID) {
            document.getElementById("passwordChangeMenu" + childID).innerHTML = "";
        }

        function submitPasswordChange(childID) {
            var pass, passConfirm;
            pass = document.getElementById("newPass" + childID).value;
            passConfirm = document.getElementById("newPassConfirm" + childID).value;

            if (pass == passConfirm) {
                //send to server !

                closePassChangeMenu(childID);
            } else alert("Passwords do not match!");
        }

        document.addEventListener("scroll", function () {
            componentHandler.upgradeDom()
        });


        function sendRemoveRequest(childID) {
            socket.emit("delete_parent", {
                pid: Number.parseInt(dataStructure.credentials.pid)
                , kid: Number.parseInt(childID)
            })
        }

        function removeKid(childID) {
            var i = 0;
            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    document.getElementById("kidCard" + childID).parentElement.innerHTML = "";
                    dataStructure.children[i].kid_location_and_name.marker.setMap(null);
                    dataStructure.children.splice(i, 1);

                }
            }
        }


        function generateChildCard(childInfo) {
            childInfo.kid_location_and_name.marker = new google.maps.Marker({
                position: new google.maps.LatLng(childInfo.kid_location_and_name.latitude, childInfo.kid_location_and_name.longitude)
                , map: kidMap
                , label: "C"
            });


            staticTargetCount[childInfo.kid_location_and_name.kid] = childInfo.static_targets.length;
            var statusIcon = "offline_icon.png";
            if (childInfo.kid_location_and_name.is_online)
                statusIcon = "online_icon.png";
            var cardCode = "<div id = \"kidCard" + childInfo.kid_location_and_name.kid + "\" class=\"kid-card mdl-shadow--8dp\">";
            cardCode += "<div class=\"kid-card-top\">";

            cardCode += "<button style =\"margin-bottom:5px;\" class=\"kid-button mdl-button mdl-js-button mdl-js-ripple-effect\" onclick = \"centerOnChild('" + childInfo.kid_location_and_name.kid + "'\);\">" + childInfo.kid_location_and_name.first_name + " " + childInfo.kid_location_and_name.last_name + "<img id=\"statusIcon" + childInfo.kid_location_and_name.kid + "\" src=\"" + statusIcon + "\" alt=\"status\" height=\"15px\" width=\"15px\" style = \"position: absolute; right: 5px; top: 10px;\"></button>";
            cardCode += "<button id=\"kidMenu" + childInfo.kid_location_and_name.kid + "\" class=\"mdl-button mdl-js-button mdl-button--icon\"><i class=\"material-icons\">more_vert</i></button>";
            cardCode += "<button id=\"handlersMenu" + childInfo.kid_location_and_name.kid + "\"class=\"handler-menu-button mdl-button mdl-js-button mdl-js-ripple-effect\" onclick =\"toggleChildHandlers('" + childInfo.kid_location_and_name.kid + "','1')\"><i class=\"material-icons\">people</i></button>";
            cardCode += " <button id=\"kidVisibilityButton" + childInfo.kid_location_and_name.kid + "\" class=\"visibility-button mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-color--grey\" style = \"width:125px;\" onclick = \"toggleVisibility('" + childInfo.kid_location_and_name.kid + "','0')\">Show info<i class=\"material-icons\" style = \"position: absolute; right: 5px; top: 6px;\">visibility</i></button>";
            cardCode += "<ul class=\"mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect\" for=\"kidMenu" + childInfo.kid_location_and_name.kid + "\" >";
            cardCode += "<li class=\"mdl-menu__item\" onclick = \"enableStaticTargetDrawing('" + childInfo.kid_location_and_name.kid + "')\"\"    \">Add new area</li>";
            cardCode += "<li class=\"mdl-menu__item\" onclick = \"showProxMenu(" + childInfo.kid_location_and_name.kid + ")\">Proximity alert</li>";
            cardCode += "<li class=\"mdl-menu__item\" onclick = \"showNearbyKids('" + childInfo.kid_location_and_name.kid + "')\"\"    \">Nearby kids</li>";
            cardCode += "<li class=\"mdl-menu__item\" onclick = \"showPasswordChangeMenu('" + childInfo.kid_location_and_name.kid + "')\"\">Change password</li>";
            cardCode += "<li class=\"mdl-menu__item\" onclick = \"sendRemoveRequest('" + childInfo.kid_location_and_name.kid + "')\">Stop tracking</li></ul></div>";
            cardCode += "<div class=\"mdl-card__actions mdl-card--border\">";
            cardCode += "<div id=\"proxMenu" + childInfo.kid_location_and_name.kid + "\"></div>";
            cardCode += "<div id=\"passwordChangeMenu" + childInfo.kid_location_and_name.kid + "\"></div>";
            cardCode += "<div id=\"handlerList" + childInfo.kid_location_and_name.kid + "\"></div>";
            cardCode += "<div id=\"staticTargets" + childInfo.kid_location_and_name.kid + "\">" + generateStaticTargets(childInfo.static_targets, childInfo.kid_location_and_name.kid) + "</div>";
            cardCode += "<div id=\"dynamicTargets" + childInfo.kid_location_and_name.kid + "\">" + generateDynamicTargets(childInfo.kid_location_and_name.kid, childInfo.dynamic_targets) + "</div></div></div>";
            return cardCode;
        }

        function toggleVisibility(childID, toggle) {
            button = document.getElementById("kidVisibilityButton" + childID);
            if (toggle == 1) {
                button.innerHTML = "Hide info<i class=\"material-icons\" style = \"position: absolute; right: 5px; top: 6px;\">visibility_off</i>";
                button.onclick = function () {
                    toggleVisibility(childID, 0);
                    toggleChildVisibility(childID, "hidden");
                };
            } else {
                button.innerHTML = "Show info<i class=\"material-icons\" style = \"position: absolute; right: 5px; top: 6px;\">visibility</i>";
                button.onclick = function () {
                    toggleVisibility(childID, 1);
                    toggleChildVisibility(childID, "visible");
                };
            }

        }

        function toggleChildVisibility(childID, visibility) {
            var i = 0
                , j = 0;
            if (visibility == "hidden") {
                for (i = 0; i < dataStructure.children.length; ++i) {
                    if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                        dataStructure.children[i].kid_location_and_name.marker.setMap(null);
                        for (j = 0; j < dataStructure.children[i].static_targets.length; ++j) {
                            dataStructure.children[i].static_targets[j].circle.setMap(null);
                        }
                        for (j = 0; j < dataStructure.children[i].dynamic_targets.length; ++j) {
                            dataStructure.children[i].dynamic_targets[j].circle.setMap(null);
                            dataStructure.children[i].dynamic_targets[j].marker.setMap(null);
                        }
                    }
                }
            } else {
                for (i = 0; i < dataStructure.children.length; ++i) {
                    if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                        dataStructure.children[i].kid_location_and_name.marker.setMap(kidMap);
                        for (j = 0; j < dataStructure.children[i].static_targets.length; ++j) {
                            dataStructure.children[i].static_targets[j].circle.setMap(kidMap);
                        }
                        for (j = 0; j < dataStructure.children[i].dynamic_targets.length; ++j) {
                            dataStructure.children[i].dynamic_targets[j].circle.setMap(kidMap);
                            dataStructure.children[i].dynamic_targets[j].marker.setMap(kidMap);
                        }
                    }
                }
            }
        }


        function addChild(newChildInfo) {
            var newKidCard = document.createElement("p");
            dataStructure.children.push(newChildInfo);
            document.getElementById('cards').appendChild(newKidCard).innerHTML = generateChildCard(newChildInfo);
            newKidAlert(newChildInfo);
            componentHandler.upgradeDom();
        }

        function addStaticTargetToCard(staticTargetInformation) {
            addNewStaticTarget(staticTargetInformation);
            var newTarget = document.createElement("e");

            var code = "";
            code += "<div id=\"staticTarget" + staticTargetInformation.static_target_id + "\">";
            code += "<button class=\"st-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect mdl-color--teal\" onclick = \"centerOnStaticTarget('" + staticTargetInformation.static_target_id + "')\">Area " + ((staticTargetCount[staticTargetKidID]++) + 1) + "</button>";
            code += "<span style=\"position: relative;left: 5px;\">";
            code += "<label class=\"mdl-icon-toggle mdl-js-icon-toggle mdl-js-ripple-effect\" for=\"editToggle" + staticTargetInformation.static_target_id + "\">";
            code += "<input type=\"checkbox\" id=\"editToggle" + staticTargetInformation.static_target_id + "\" class=\"mdl-icon-toggle__input\" onclick = \"toggleEdit('" + staticTargetInformation.static_target_id + "')\">";
            code += "<i class=\"mdl-icon-toggle__label material-icons\">mode_edit</i>";
            code += "</label>&#160; &#160;";
            code += "<button class=\"mdl-button mdl-js-button mdl-button--icon\" onclick = \"sendStaticTargetDeleteRequest('" + staticTargetInformation.static_target_id + "')\"><i class=\"material-icons\">delete</i></button></span></div>";

            document.getElementById("staticTargets" + staticTargetKidID).appendChild(newTarget).innerHTML = code;
            componentHandler.upgradeDom();
        }

        function generateStaticTargets(staticTargetsInfo, childID) {
            var i = 0;
            var targetCode = "";
            for (i = 0; i < staticTargetsInfo.length; i++) {
                placeStaticTarget(staticTargetsInfo[i], childID);
                targetCode += "<div id=\"staticTarget" + staticTargetsInfo[i].static_target_id + "\">";
                targetCode += "<button class=\"st-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect mdl-color--blue\" onclick = \"centerOnStaticTarget('" + staticTargetsInfo[i].static_target_id + "')\">Area " + (i + 1) + "</button>";
                targetCode += "<span style=\"position: relative;left: 5px;\">";
                targetCode += "<label class=\"mdl-icon-toggle mdl-js-icon-toggle mdl-js-ripple-effect\" for=\"editToggle" + staticTargetsInfo[i].static_target_id + "\">";
                targetCode += "<input type=\"checkbox\" id=\"editToggle" + staticTargetsInfo[i].static_target_id + "\" class=\"mdl-icon-toggle__input\" onclick = \"toggleEdit('" + staticTargetsInfo[i].static_target_id + "')\">";
                targetCode += "<i class=\"mdl-icon-toggle__label material-icons\">mode_edit</i>";
                targetCode += "</label>&#160; &#160;";
                targetCode += "<button class=\"mdl-button mdl-js-button mdl-button--icon\" onclick = \"sendStaticTargetDeleteRequest('" + staticTargetsInfo[i].static_target_id + "')\"><i class=\"material-icons\">delete</i></button></span></div>";
            }
            return targetCode;
        }

        function placeStaticTarget(targetInfo, childID) {
            var i, j;

            for (i = 0; i < dataStructure.children.length; ++i)
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    for (j = 0; j < dataStructure.children[i].static_targets.length; ++j)
                        if (dataStructure.children[i].static_targets[j].static_target_id == targetInfo.static_target_id) {
                            dataStructure.children[i].static_targets[j].circle = new google.maps.Circle({
                                strokeColor: '#333F4F'
                                , strokeOpacity: 1
                                , strokeWeight: 1
                                , fillColor: getRandomColor()
                                , fillOpacity: 0.4
                                , map: null
                                , editable: false
                                , draggable: false
                                , center: new google.maps.LatLng(targetInfo.latitude, targetInfo.longitude)
                                , radius: targetInfo.radius
                            , });
                        }
                }
        }

        function addNewStaticTarget(targetInfo) {
            var i = 0;

            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == targetInfo.kid) {
                    targetInfo.circle = new google.maps.Circle({
                        strokeColor: '#333F4F'
                        , strokeOpacity: 1
                        , strokeWeight: 1
                        , fillColor: getRandomColor()
                        , fillOpacity: 0.4
                        , map: null
                        , editable: false
                        , draggable: false
                        , center: new google.maps.LatLng(targetInfo.latitude, targetInfo.longitude)
                        , radius: targetInfo.radius
                    , });

                    dataStructure.children[i].static_targets.push(targetInfo);
                }
            }
            console.log(dataStructure.children[0].static_targets);
        }




        function generateDynamicTargets(childID, dynamicTargetsInfo) {
            var i = 0;
            var targetsCode = ""
                , statusIcon = "offline_icon.png";
            for (i = 0; i < dynamicTargetsInfo.length; i++) {
                dynamicTargetsInfo[i].marker = new google.maps.Marker({
                    position: new google.maps.LatLng(dynamicTargetsInfo[i].latitude, dynamicTargetsInfo[i].longitude)
                    , map: null
                    , label: "P"
                })
                dynamicTargetsInfo[i].circle = new google.maps.Circle({
                    strokeColor: '#333F4F'
                    , strokeOpacity: 1
                    , strokeWeight: 1
                    , fillColor: getRandomColor()
                    , fillOpacity: 0.4
                    , map: null
                    , editable: false
                    , draggable: false
                    , center: new google.maps.LatLng(dynamicTargetsInfo[i].latitude, dynamicTargetsInfo[i].longitude)
                    , radius: dynamicTargetsInfo[i].radius
                , });

                if (dynamicTargetsInfo[i].is_online)
                    statusIcon = "online_icon.png";

                if (dynamicTargetsInfo[i].pid == dataStructure.credentials.pid) {
                    targetsCode += "<div><button id=\"dynamicTarget" + dynamicTargetsInfo[i].pid + "." + childID + "\" class=\"dt-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect\" style = \"width:170px;\" onclick =\"centerOnDynamicTarget(" + childID + "," + dynamicTargetsInfo[i].pid + ")\">" + getHandlerNameByPID(childID, dynamicTargetsInfo[i].pid) + "<img id=\"statusIcon" + dynamicTargetsInfo[i].pid + "." + childID + "\" src=\"" + statusIcon + "\" alt=\"status\" height=\"15px\" width=\"15px\" style = \"position: absolute; right: 12px; top: 10px;\"></button>";
                    targetsCode += "<button class=\"mdl-button mdl-js-button mdl-button--icon\" onclick = \"sendDynamicTargetDeleteRequest(" + childID + "," + dynamicTargetsInfo[i].pid + ")\"><i class=\"material-icons\">delete</i></button></div>";
                } else {
                    targetsCode += "<div><button id=\"dynamicTarget" + dynamicTargetsInfo[i].pid + "." + childID + "\" class=\"dt-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect\" onclick =\"centerOnDynamicTarget(" + childID + "," + dynamicTargetsInfo[i].pid + ")\">" + getHandlerNameByPID(childID, dynamicTargetsInfo[i].pid) + "<img id=\"statusIcon" + dynamicTargetsInfo[i].pid + "." + childID + "\" src=\"" + statusIcon + "\" alt=\"status\" height=\"15px\" width=\"15px\" style = \"position: absolute; right: 12px; top: 10px;\"></button></div>";
                }
            }

            return targetsCode;
        }

        function changeDynamicTargetStatus(childID, parentID, isOnline) {
            if (isOnline == true)
                document.getElementById("statusIcon" + parentID + "." + childID).src = "online_icon.png";
            else document.getElementById("statusIcon" + parentID + "." + childID).src = "offline_icon.png";
        }

        function changeChildStatus(childID, isOnline) {
            if (isOnline == true)
                document.getElementById("statusIcon" + childID).src = "online_icon.png";
            else document.getElementById("statusIcon" + childID).src = "offline_icon.png";
        }

        function sendDynamicTargetDeleteRequest(childID, parentID) {
            socket.emit("delete_dynamic_target", Number.parseInt(childID));
        }

        function deleteDynamicTarget(childID, parentID) {
            var dTarget = getDynamicTarget(childID, parentID)
                , i = 0
                , j = 0;
            dTarget.circle.setMap(null);
            dTarget.marker.setMap(null);
            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    for (j = 0; j < dataStructure.children[i].dynamic_targets.length; ++j) {
                        if (dataStructure.children[i].dynamic_targets[j].pid == parentID) {
                            dataStructure.children[i].dynamic_targets.splice(j, 1);
                            document.getElementById("dynamicTarget" + parentID + "." + childID).parentElement.innerHTML = "";
                        }
                    }
                }
            }
        }

        function updateDynamicTarget(updatedInfo) {
            var dTarget = getDynamicTarget(updatedInfo.kid, updatedInfo.pid);

            dTarget.circle.setCenter(new google.maps.LatLng(updatedInfo.latitude, updatedInfo.longitude));
            dTarget.marker.setPosition(new google.maps.LatLng(updatedInfo.latitude, updatedInfo.longitude));
            dTarget = updatedInfo;
        }

        function displayKidRegisterWindow() {
            document.getElementById('registerWindow').style.zIndex = "10";
            document.getElementById('registerWindow').style.visibility = "visible";
        }

        function closeKidRegisterWindow() {
            document.getElementById('registerWindow').style.zIndex = "0";

        }

        function showNearbyKids(childID) {
            /*SEND CHILD ID TO SERVER AND WAIT FOR RESPONSE!*/



            var i = 0
                , windowCode = "";
            windowCode += "<div id=\"nearbyKidsWindow\" class=\"mdl-shadow--16dp\"><div class=\"mdl-grid\">";
            for (i = 0; i < nearbyKids.length; i++) {
                windowCode += "<div class=\"mdl-cell mdl-cell--2-col mdl-shadow--4dp\">";
                windowCode += "<button class=\"nearby-kid-button mdl-button mdl-js-button mdl-js-ripple-effect\">" + nearbyKids[i].first_name + " " + nearbyKids[i].last_name + "</button></div>";
            }
            windowCode += "<div class=\"mdl-cell mdl-cell--2-col\"><button class=\"nearby-kid-button mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent\" onclick = \"closeNearbyKids()\"><i class=\"material-icons\">close</i></button></div></div></div>";


            console.log(windowCode);
            var window = document.createElement('e');
            document.getElementById('nearbyKids').appendChild(window).innerHTML = windowCode;

        }

        function closeNearbyKids() {
            document.getElementById('nearbyKidsWindow').parentNode.parentNode.innerHTML = "";
        }

        function getDynamicTarget(childID, parentID) {
            var i = 0
                , j = 0;
            for (i = 0; i < dataStructure.children.length; i++) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    for (j = 0; j < dataStructure.children[i].dynamic_targets.length; j++) {
                        if (dataStructure.children[i].dynamic_targets[j].pid == parentID)
                            return dataStructure.children[i].dynamic_targets[j];
                    }
                }
            }
        }

        function deleteHandler(childID, parentID) {
            var i = 0
                , j = 0;

            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID) {
                    for (j = 0; j < dataStructure.children[i].child_handlers.length; ++j) {
                        if (dataStructure.children[i].child_handlers[j].pid == parentID) {
                            dataStructure.children[i].child_handlers.splice(j, 1);
                            deleteDynamicTarget(childID, parentID);
                            document.getElementById("handler" + childID + "." + parentID).innerHTML = "";
                        }
                    }
                }
            }
        }


        function sendInput() {

            var registrationInformation = {
                parrentID: dataStructure.parentID
                , username: document.getElementById("usernameField").value
                , password: document.getElementById("passwordField").value
                , first_name: document.getElementById("firstNameField").value
                , last_name: document.getElementById("lastNameField").value
            };

            // SEND THIS TO THE SERVER!!!!!!!!!!!!!!!!

            document.getElementById("usernameField").value = '';
            document.getElementById("passwordField").value = '';
            document.getElementById("firstNameField").value = '';
            document.getElementById("lastNameField").value = '';

            socket.emit('register_kid', registrationInformation);

        }


        function showEventAlertNotification(eventInfo, childID) {
            var messageText;
            switch (eventInfo.type) {
            case 1:
                messageText = "Car accident near";
                break;
            case 2:
                messageText = "Traffic congestion near";
                break;
            case 3:
                messageText = "Disabled vehicle near";
                break;
            case 4:
                messageText = "Large group of people near";
                break;
            case 5:
                messageText = "Unknown incident near";
                break;
            case 6:
                messageText = "Unknown incident near";
                break;
            case 7:
                messageText = "A new major event has been planned near";
                break;
            case 8:
                messageText = "Road hazard near";
                break;
            case 9:
                messageText = "Construction site near";
                break;
            case 10:
                messageText = "Kidnapping near";
                break;
            case 11:
                messageText = "Weather alert near";
                break;
            default:
                messageText = "Unknown incident near";
                break;
            }
            var notificationCode = "";
            notificationCode += "<div id=\"alert" + alertCount + "\" class=\"alert-notification-card mdl-card mdl-shadow--8dp\">";
            notificationCode += "<div class=\"mdl-card__title mdl-card--border\">";
            notificationCode += "<h2 class=\"mdl-card__title-text\">Alert!</h2></div>";
            notificationCode += "<div class=\"mdl-card__supporting-text\">" + messageText + " " + getNameFromKid(childID) + "!</div>";
            notificationCode += "<div class=\"mdl-card__actions mdl-card--border\">";
            notificationCode += "<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent\" onclick = \"dismissAlert('" + (alertCount++) + "')\"> Dismiss </button></div></div>";

            var newAlert = document.createElement("e");
            document.getElementById('notification-holder').insertBefore(newAlert, document.getElementById('notification-holder').childNodes[0]).innerHTML = notificationCode;

        }


        function updateIncidents(incidentsData) {
            var i = 0
                , j = 0;

            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == incidentsData.kid) {
                    dataStructure.children[i].incidents = incidentsData.events;
                    placeIncidentsMarkers(dataStructure.children[i].incidents);
                    displayIncidentAlerts(incidentsData.events, incidentsData.kid);
                }

            }

        }

        function displayIncidentAlerts(events, childID) {
            var i = 0;
            for (i = 0; i < events.length; ++i) {
                showEventAlertNotification(events[i], childID);
            }
        }

        function placeIncidentsMarkers(incidents) {
            var i = 0;
            for (i = 0; i < incidents.length; ++i) {
                incidents[i].marker = new google.maps.Marker({
                    position: new google.maps.LatLng(incidents[i].latitude, incidents[i].longitude)
                    , map: kidMap
                    , label: "I"
                    , animation: google.maps.Animation.DROP
                });
            }
        }

        function getIncidentObject(childID, incidentsData) {
            var i, j;
            for (i = 0; i < incidentsData.length; ++i) {
                if (incidentsData[i].kid == childID) {
                    for (j = 0; j < incidentsData[i].events.length; ++j)
                        incidentsData[i].events[j].marker = new google.maps.Marker({
                            position: new google.maps.LatLng(incidentsData[i].events[j].latitude, incidentsData[i].events[j].longitude)
                            , map: kidMap
                            , label: "I"
                            , animation: google.maps.Animation.DROP
                        });
                    return incidentsData[i];
                }
            }
        }

        function addHandler(data) {
            var i = 0
                , newHandler = {
                    pid: data.pid
                    , first_name: data.first_name
                    , last_name: data.last_name
                    , username: data.username
                    , is_dynamic_target: false
                }

            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == data.kid)
                    dataStructure.children[i].child_handlers.push(newHandler);
            }

        }
        var socket;

        function renderPage() {
            socket = io();

            socket.on("new_parent", function (data) {
                console.log(data);
                addHandler(data);
            });

            socket.on("incidents", function (data) {
                console.log(data);
                updateIncidents(data);
            });

            socket.on("deleted_parent", function (data) {
                console.log(data)
                deleteHandler(data.kid, data.pid);
            })

            socket.on("deleted_child", function (data) {
                console.log(data)
                removeKid(data.kid);
            });

            socket.on("new_child", function (data) {
                console.log(data);
                addChild(data);
            });

            socket.on("offline_dynamic_target", function (data) {
                console.log(data);
                changeDynamicTargetStatus(data.kid, data.pid, false);
            });

            socket.on("offline_child", function (data) {
                console.log(data)
                changeChildStatus(data.kid, false);
            });

            socket.on("dynamic_target_new_location", function (data) {
                console.log(data);
                updateDynamicTarget(data);
                changeDynamicTargetStatus(data.kid, data.pid, true);

            });

            socket.on("alert_geofencing", function (data) {
                console.log(data);
                areaUpdateAlert(data);
            })

            socket.on('new_child_location', function (data) {
                console.log(data);
                moveKid(data);
                changeChildStatus(data.kid, true);
            });

            socket.on('initial_object', function (data) {
                console.log(data);
                generateShit(data);
                console.log(data);
            });

            socket.on('deleted_static_target', function (data) {
                console.log(data);
                deleteStaticTarget(data.kid, data.static_id);
            });



            socket.on('new_static_target', function (data) {
                console.log(data);
                addStaticTargetToCard(data);
            });

            socket.on("new_dynamic_target", function (data) {
                insertNewDynamicTarget(data);
            });

            socket.on("deleted_dynamic_target", function (data) {
                deleteDynamicTarget(data.kid, data.pid);
            });
        }

        function deleteStaticTarget(childID, targetID) {
            var i = 0
                , j = 0;
            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID)
                    for (j = 0; j < dataStructure.children[i].static_targets.length; ++j) {
                        if (dataStructure.children[i].static_targets[j].static_target_id == targetID) {
                            dataStructure.children[i].static_targets[j].circle.setMap(null);
                            dataStructure.children[i].static_targets.splice(j, 1);
                            document.getElementById("staticTarget" + targetID).parentNode.removeChild(document.getElementById("staticTarget" + targetID));
                        }
                    }
            }

        }


        function toggleChildHandlers(childID, toggle) {
            button = document.getElementById("handlersMenu" + childID);
            if (toggle == 1) {
                button.innerHTML = "<i class=\"material-icons\">people_outline</i>";
                showChildHandlers(childID);
                button.onclick = function () {
                    toggleChildHandlers(childID, 0);
                };
            } else {
                button.innerHTML = "<i class=\"material-icons\">people</i>";
                document.getElementById("handlerList" + childID).innerHTML = "";
                button.onclick = function () {
                    toggleChildHandlers(childID, 1);
                };
            }


        }


        function showChildHandlers(childID) {

            var listCode = ""
                , handlerList = document.createElement('e');
            listCode += "<ul class = mdl-list>" + listHandlers(childID) + "</ul>"

            document.getElementById("handlerList" + childID).appendChild(handlerList).innerHTML = listCode;
            componentHandler.upgradeDom();
        }

        function listHandlers(childID) {
            var handlersCode = ""
                , i = 0
                , j = 0;
            for (i = 0; i < dataStructure.children.length; ++i) {
                if (dataStructure.children[i].kid_location_and_name.kid == childID)
                    for (j = 0; j < dataStructure.children[i].child_handlers.length; ++j) {
                        if (dataStructure.children[i].child_handlers[j].pid != dataStructure.credentials.pid) {
                            handlersCode += "<div id = \"handler" + childID + "." + dataStructure.children[i].child_handlers[j].pid + "\"><li class =\"mdl-list__item\"><span class=\"mdl-list__item-primary-content\"><button class=\"handler-button mdl-button mdl-js-button\">" + dataStructure.children[i].child_handlers[j].first_name + " " + dataStructure.children[i].child_handlers[j].last_name + "</button>";
                            handlersCode += "<button class=\"mdl-button mdl-js-button mdl-button--icon\" style=\"position:relative;left: 5px;\" onclick=\"sendRemoveHandlerRequest('" + dataStructure.children[i].kid_location_and_name.kid + "','" + dataStructure.children[i].child_handlers[j].pid + "')\"><i class=\"material-icons\">delete</i></button></span></li><div>";
                        }
                    }
            }
            return handlersCode;

        }

        function sendRemoveHandlerRequest(childID, parentID) {
            socket.emit("delete_parent", {
                pid: Number.parseInt(parentID)
                , kid: Number.parseInt(childID)
            })
        }

        function sendToServer(newTarget) {
            socket.emit('add_static_target', {
                'kid': Number.parseInt(newTarget.kid)
                , 'latitude': newTarget.latitude
                , 'longitude': newTarget.longitude
                , 'radius': Number.parseInt(newTarget.radius)
            });
        }

        function generateShit(object) {
            dataStructure = object;
            loadKids();
            loadUsername();
            componentHandler.upgradeDom();
        }

        function reenderPage() {
            loadKids();
            loadUsername();
            componentHandler.upgradeDom();
        }

        /////////////////////////////////////////////////////////////////////////////////////////

        function testingShit() {
            dataStructure.children[0].static_targets[0].circle = new google.maps.Circle({
                strokeColor: '#333F4F'
                , strokeOpacity: 1
                , strokeWeight: 1
                , fillColor: getRandomColor()
                , fillOpacity: 0.4
                , map: kidMap
                , editable: false
                , draggable: false
                , center: new google.maps.LatLng(45, 27)
                , radius: 100000
            , });

            console.log(dataStructure.children[0].static_targets[0]);

        }

        function makeVisible() {
            dataStructure.children[0].static_targets[0].circle.setMap(kidMap);
        }

        function makeInvisible() {
            dataStructure.children[0].static_targets[0].circle.setMap(null);
        }

        function showTextField() {
            document.getElementById("kidAddingArea").innerHTML = "";
            var textField = document.createElement("e");
            var textFieldCode = "";

            textFieldCode += "<div class=\"mdl-textfield mdl-js-textfield mdl-textfield--floating-label\" style = \"width:205px;position:relative; left:15px;\">";
            textFieldCode += "<input class=\"mdl-textfield__input\" type=\"text\" id=\"kidCode\" required>";
            textFieldCode += "<label class=\"mdl-textfield__label\" for=\"kidCode\">Enter Verification Code</label></div>";
            textFieldCode += "<button class=\"mdl-button mdl-js-button mdl-button--primary\" onclick = \" sendKidAddingCode() \" style =\"position:relative; left:15px;margin-bottom:5px;\">Send code</button>";
            textFieldCode += "<button class=\"mdl-button mdl-js-button mdl-button--accent\" style=\"position: relative; left: 48px;margin-bottom:5px;\" onclick = \" closeKidAddingArea() \" >Cancel</button>"

            document.getElementById("kidAddingArea").appendChild(textField).innerHTML = textFieldCode;
            componentHandler.upgradeDom();
        }


        function closeKidAddingArea() {
            document.getElementById("kidAddingArea").innerHTML = "<button id=\"addKidButton\" class=\"userMenu-button mdl-button mdl-js-button mdl-js-ripple-effect\" onclick=\"showTextField()\">Add child <i class=\"material-icons\" style=\"position:absolute;right:10px;top:10px;\">add_box</i></button>";

        }


        function sendKidAddingCode() {

            console.log(document.getElementById("kidCode").value);
            var xhttp = new XMLHttpRequest();
            var to_send = 'password=' + document.getElementById('kidCode').value;
            xhttp.open("POST", "add-child-by-code", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

            xhttp.onreadystatechange = function () { //Call a function when the state changes.
                if (xhttp.readyState == 4) {
                    console.log(xhttp.responseText);
                }
            };
            xhttp.send(to_send);
            closeKidAddingArea();
        }
    </script>



    <title>Kido</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="./material.min.js"></script>


</head>

<body id="plsWork" onload="renderPage()">

    <div class="interface-area mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
        <div class="mdl-layout__drawer  mdl-color--blue">
            <div class="userMenu">
                <button id="username" class="userMenu-button mdl-button mdl-js-button mdl-js-ripple-effect"></button>
                <button id="kidRegister" class="userMenu-button mdl-button mdl-js-button mdl-button--primary" onclick="displayKidRegisterWindow()">Register child<i class="material-icons" style="position:absolute;right:10px;top:10px;">playlist_add</i></button>
                <div id="kidAddingArea">
                    <button id="addKidButton" class="userMenu-button mdl-button mdl-js-button mdl-js-ripple-effect" onclick="showTextField()">Add child <i class="material-icons" style="position:absolute;right:10px;top:10px;">add_box</i></button>
                </div>
                <button class="userMenu-halfButton mdl-button mdl-js-button mdl-js-ripple-effect" style="margin-left:5px;">Help<i class="material-icons" style="position:absolute;right:10px;top:10px;">help</i></button>
                <button class="userMenu-halfButton mdl-button mdl-js-button mdl-button--accent" style="position:relative;left:15px;" onclick="window.location='/logout';"> Logout <i class="material-icons" style="position:absolute;right:10px;top:10px;">exit_to_app</i></button>

                <br/>
            </div>
            <br/>
            <div id="kidCards">
                <div id="kid-card-holder">
                    <div id="cards">
                    </div>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                </div>
            </div>
        </div>
        <main class="mdl-layout__content">
            <div class="page-content">
                <div id="map" style="height: 100vh;">
                </div>
            </div>
        </main>
    </div>


    <div class="testButtons" style="visibility:hidden;">
        <div class="kid-card mdl-shadow--8dp">
            <form>
                <input type="button" onclick="newKidAlert(dataStructure.children[0])" value="New kid alert">
                <input type="button" onclick="testAreaUpdateAlert()" value="area alert">
                <input type="button" onclick="showEventAlertNotification({event:{type:1},kid:3})" value="Accident">
                <input type="button" onclick="showEventAlertNotification({event:{type:2},kid:3})" value="Contestion">
                <input type="button" onclick="showEventAlertNotification({event:{type:3},kid:3})" value="Disabled Vehicle">
                <input type="button" onclick="showEventAlertNotification({event:{type:4},kid:3})" value="Group of people">
                <input type="button" onclick="showEventAlertNotification({event:{type:5},kid:3})" value="Unknown 1">
                <input type="button" onclick="showEventAlertNotification({event:{type:6},kid:3})" value="Unknows 2">
                <input type="button" onclick="showEventAlertNotification({event:{type:7},kid:3})" value="Major Event">
                <input type="button" onclick="showEventAlertNotification({event:{type:8},kid:3})" value="Road Hazard">
                <input type="button" onclick="showEventAlertNotification({event:{type:9},kid:3})" value="Construction">
                <input type="button" onclick="showEventAlertNotification({event:{type:10},kid:3})" value="Kidnapping">
                <input type="button" onclick="showEventAlertNotification({event:{type:11},kid:3})" value="Weather">
                <input type="button" onclick="showEventAlertNotification({event:{type:65},kid:3})" value="Undefined">
                <input type="button" onclick="makeInvisible()" value="2">
                <input type="button" onclick="testingShit()" value="move kid to cursor">
            </form>
        </div>
    </div>

    <div id="notification-area">
        <div id="notification-holder">

        </div>
    </div>



    <div id="nearbyKids">

    </div>

    <div id="registrationArea">
        <div id="registerWindow" class="mdl-shadow--16dp">
            <h3><span style="color:dodgerblue;position: relative;top: 15px;left: 135px;z-index:15;">Register a child</span></h3>
            <div style="position:absolute; top: 20px;left: 115px;height: 340px;width:270px;background-color:ghostwhite;" class="mdl-shadow--16dp"></div>
            <div style="width: 250px;height: 50px;overflow:hidden;position: relative;left: 125px;">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="usernameField" required>
                    <label class="mdl-textfield__label" for="usernameField">Username</label>
                </div>
            </div>
            <div style="width: 250px;height: 50px;overflow:hidden;position: relative;left: 125px;">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="password" id="passwordField" required>
                    <label class="mdl-textfield__label" for="passwordField">Password</label>
                </div>
            </div>
            <div style="width: 120px;height: 50px;overflow:hidden;position: relative;left: 125px;">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="firstNameField" required>
                    <label class="mdl-textfield__label" for="firstNameField">First Name</label>
                </div>
            </div>
            <div style="width: 120px;height: 50px;position: absolute;top:188px;right: 125px;">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="lastNameField" required>
                    <label class="mdl-textfield__label" for="lastNameField">Last Name</label>
                </div>
            </div>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--primary" style="width:150px;height:50px;position: absolute; top: 300px;left:135px;" onclick="sendInput();closeKidRegisterWindow()">Register</button>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" style="width:50px;height:50px;position: absolute; top: 300px;left:300px;" onclick="closeKidRegisterWindow()"><i class="material-icons">close</i></button>
        </div>
    </div>

    <div id="newKidHelp" class="mdl-shadow--16dp">
        <div class="kid-card mdl-shadow--8dp">
            <div class="kid-card-top">
                <button id="demoChildName" class="kid-button mdl-button mdl-js-button mdl-js-ripple-effect">Child Name</button>
                <div class="mdl-tooltip mdl-tooltip--large" for="demoChildName">Click to move the map to the current position of the child</div>
                <div class="mdl-tooltip mdl-tooltip--large" for="demoChildMenu">Click to show aditional options</div>

                <button id="demoChildMenu" class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">more_vert</i></button>
                <ul for="demoChildMenu" class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect">
                    <li id="demoStaticTargetAdder" class="mdl-menu__item">Add Static Target</li>
                    <div class="mdl-tooltip mdl-tooltip--large" for="demoStaticTargetAdder">Draw a circle on the
                        <br/>map and get alerts
                        <br/>when the child enters
                        <br/>or leave area</div>
                    <li id="demoDynamicTargetAdder" class="mdl-menu__item">Proximity Alert</li>
                    <div class="mdl-tooltip mdl-tooltip--large" for="demoDynamicTargetAdder">Set a radius around
                        <br/>your location and get
                        <br/>alerts when the child
                        <br/>gets too far away</div>
                    <li id="demoRemoveChild" class="mdl-menu__item">Stop following</li>
                    <div class="mdl-tooltip mdl-tooltip--large" for="demoRemoveChild">Stop following child</div>
                    <li id="demoNearbyKids" class="mdl-menu__item">Nearby kids</li>
                </ul>
                <div class="mdl-tooltip mdl-tooltip--large" for="demoNearbyKids">Show kids near this child</div>
            </div>
            <div class="mdl-tooltip mdl-tooltip--large" for="demoStaticTargetButton">Move map to that area</div>
            <div class="mdl-tooltip mdl-tooltip--large" for="demoEditToggle">Allows you to more and resize Area 1</div>
            <div class="mdl-tooltip mdl-tooltip--large" for="demoRemoveTarget">Deletes Area 1</div>
            <div class="mdl-tooltip mdl-tooltip--large" for="demoDynamicTarget">Moves the map to the current location of this person</div>

            <div class="mdl-card__actions mdl-card--border">
                <div class="staticTargets">
                    <div id="staticTarget+staticTargetID">
                        <button id="demoStaticTargetButton" class="st-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect">Area 1</button>
                        <span style="position: relative;left: 5px;">
                            <label id="demoEditToggle" class="mdl-icon-toggle mdl-js-icon-toggle mdl-js-ripple-effect" for="icon-toggle-1">
                                <input type="checkbox" id="icon-toggle-1" class="mdl-icon-toggle__input">
                                <i class="mdl-icon-toggle__label material-icons">mode_edit</i>
                            </label>&#160;&#160;
                            <button id="demoRemoveTarget" class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">delete</i></button>
                        </span>
                    </div>
                </div>
                <div class="dynamicTargets">
                    <button id="demoDynamicTarget" class="dt-button mdl-button mdl-js-button mdl-button mdl-js-ripple-effect">Dynamic Target 1</button>
                </div>
            </div>
        </div>
        <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" style="position:relative; left: 50px;" onclick="hideNewKidHelp()">understood</button>
    </div>
</body>

</html>